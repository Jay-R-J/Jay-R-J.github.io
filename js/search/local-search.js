class LocalSearch{constructor({path:e="",unescape:t=!1,top_n_per_article:a=1}){this.path=e,this.unescape=t,this.top_n_per_article=a,this.isfetched=!1,this.datas=null}getIndexByWord(e,t,a=!1){let i=[],n=new Set;return a||(t=t.toLowerCase()),e.forEach(e=>{this.unescape&&((s=document.createElement("div")).innerText=e,e=s.innerHTML);var s,l=e.length;if(0!==l){let s=0;var r;for(a||(e=e.toLowerCase());-1<(r=t.indexOf(e,s));)i.push({position:r,word:e}),n.add(e),s=r+l}}),i.sort((e,t)=>e.position!==t.position?e.position-t.position:t.word.length-e.word.length),[i,n]}mergeIntoSlice(e,t,a){var i;let{position:n,word:s}=a[0];for(var l=[],r=new Set;n+s.length<=t&&0!==a.length;){r.add(s),l.push({position:n,length:s.length});var o=n+s.length;for(a.shift();0!==a.length&&(n=(i=a[0]).position,s=i.word,o>n);)a.shift()}return{hits:l,start:e,end:t,count:r.size}}highlightKeyword(e,t){let a="",i=t.start;for(var{position:n,length:s}of t.hits)a+=e.substring(i,n),i=n+s,a+=`<mark class="search-keyword">${e.substr(n,s)}</mark>`;return a+e.substring(i,t.end)}getResultItems(e){let t=[];return this.datas.forEach(({title:a,content:i,url:n})=>{var s,[l,r]=this.getIndexByWord(e,a),[o,s]=this.getIndexByWord(e,i),r=new Set([...r,...s]).size;if(0!==(s=l.length+o.length)){var c=[];0!==l.length&&c.push(this.mergeIntoSlice(0,a.length,l));let g=[];for(;0!==o.length;){var h=o[0].position,d=Math.max(0,h-20);h=Math.min(i.length,h+100);g.push(this.mergeIntoSlice(d,h,o))}g.sort((e,t)=>e.count!==t.count?t.count-e.count:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start),0<=(l=parseInt(this.top_n_per_article,10))&&(g=g.slice(0,l));let u="";(n=new URL(n,location.origin)).searchParams.append("highlight",e.join(" ")),u+=0!==c.length?`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${this.highlightKeyword(a,c[0])}</span>`:`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${a}</span>`,g.forEach(e=>{u+=`<p class="search-result">${this.highlightKeyword(i,e)}...</p>`}),u+="</a></li>",t.push({item:u,id:t.length,hitCount:s,includedCount:r})}}),t}fetchData(){let e=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(t=>{this.isfetched=!0,this.datas=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(t),this.datas=this.datas.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(e,t,a){var i=e.nodeValue;let n=t.start;var s,l,r=[];for({position:s,length:l}of t.hits){var o=document.createTextNode(i.substring(n,s)),c=(n=s+l,document.createElement("mark"));c.className=a,c.appendChild(document.createTextNode(i.substr(s,l))),r.push(o,c)}e.nodeValue=i.substring(n,t.end),r.forEach(t=>{e.parentNode.insertBefore(t,e)})}highlightSearchWords(e){var t=new URL(location.href).searchParams.get("highlight");let a=t?t.split(" "):[];if(a.length&&e){for(var i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),n=[];i.nextNode();)i.currentNode.parentNode.matches("button, select, textarea, .mermaid")||n.push(i.currentNode);n.forEach(e=>{var[t]=this.getIndexByWord(a,e.nodeValue);t.length&&(t=this.mergeIntoSlice(0,e.nodeValue.length,t),this.highlightText(e,t,"search-keyword"))})}}}window.addEventListener("load",()=>{let{path:e,top_n_per_article:t,unescape:a,languages:i,pagination:n}=GLOBAL_CONFIG.localSearch,s=n&&n.enable,l=new LocalSearch({path:e,top_n_per_article:t,unescape:a}),r=document.querySelector(".local-search-input input"),o=document.getElementById("local-search-stats"),c=document.getElementById("loading-status"),h=!e.endsWith("json"),d=0,g=n.hitsPerPage||10,u=[],p=(s||(d=void 0,u=void 0),{get pagination(){return document.getElementById("local-search-pagination")},get paginationList(){return document.querySelector("#local-search-pagination .ais-Pagination-list")},get historyList(){return document.getElementById("local-search-history")},get historyClear(){return document.getElementById("local-search-history-clear")}}),m=10,f="local_search_history",y=()=>{try{var e=localStorage.getItem(f);return e?JSON.parse(e):[]}catch(e){return[]}},v=e=>{try{localStorage.setItem(f,JSON.stringify(e))}catch(e){}},P=()=>{var e=y(),t=p.historyList;if(t)if(0===e.length)t.style.display="none";else{t.style.display="block";let a='<h4 class="search-history-title">搜索历史</h4>';a+='<ul class="search-history-list">',e.forEach((e,t)=>{a+=`\n        <li class="search-history-item">\n          <a href="#" class="search-history-link" data-term="${encodeURIComponent(e)}">\n            <i class="fas fa-history"></i>\n            <span>${e}</span>\n            <button class="search-history-remove" data-index="${t}" title="删除">\n              <i class="fas fa-times"></i>\n            </button>\n          </a>\n        </li>\n      `}),a+="</ul>",t.innerHTML=a,t.querySelectorAll(".search-history-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),t=decodeURIComponent(e.dataset.term),r.value=t,b(),r.focus()})}),t.querySelectorAll(".search-history-remove").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();t=parseInt(e.dataset.index);var a=y();a.splice(t,1),v(a),P()})})}},w=e=>{p.pagination.style.display=s&&e?"":"none"},E=(e,t)=>{var a=document.getElementById("local-search-results"),n=s?u.slice(d*g,(d+1)*g):t;s&&0===n.length&&0<u.length?(d=0,E(e,t)):(n=n.map((e,t)=>(t=s?d*g+t+1:t+1,e.item.replace('<li class="local-search-hit-item">',`<li class="local-search-hit-item" value="${t}">`))),a.innerHTML=`<ol class="search-result-list">${n.join("")}</ol>`,n=(s?u:t).length,n=i.hits_stats.replace(/\$\{hits}/,n),o.innerHTML=`<hr><div class="search-result-stats">${n}</div>`,s&&(n=Math.ceil(u.length/g),L(d,n,e)),n=0<t.length,w(n),window.pjax&&window.pjax.refresh(a))},L=(e,t,a)=>{if(t<=1)p.pagination.style.display="none",p.paginationList.innerHTML="";else{p.pagination.style.display="block";var i=0===e,n=e===t-1,s=window.innerWidth<768?3:5;let a=Math.max(0,e-Math.floor(s/2));var l=Math.min(t-1,a+s-1);l-a+1<s&&(a=Math.max(0,l-s+1));let r="";s<t&&0<a&&(r+='\n        <li class="ais-Pagination-item ais-Pagination-item--page">\n          <a class="ais-Pagination-link" aria-label="Page 1" href="#" data-page="0">1</a>\n        </li>',1<a)&&(r+='\n          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">\n            <span class="ais-Pagination-link">...</span>\n          </li>');for(let t=a;t<=l;t++){r+=t===e?`\n          <li class="ais-Pagination-item ais-Pagination-item--page ais-Pagination-item--selected">\n            <span class="ais-Pagination-link" aria-label="Page ${t+1}">${t+1}</span>\n          </li>`:`\n          <li class="ais-Pagination-item ais-Pagination-item--page">\n            <a class="ais-Pagination-link" aria-label="Page ${t+1}" href="#" data-page="${t}">${t+1}</a>\n          </li>`}s<t&&l<t-1&&(l<t-2&&(r+='\n          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">\n            <span class="ais-Pagination-link">...</span>\n          </li>'),r+=`\n        <li class="ais-Pagination-item ais-Pagination-item--page">\n          <a class="ais-Pagination-link" aria-label="Page ${t}" href="#" data-page="${t-1}">${t}</a>\n        </li>`),1<t?p.paginationList.innerHTML=`\n            <li class="ais-Pagination-item ais-Pagination-item--previousPage ${i?"ais-Pagination-item--disabled":""}">\n              ${i?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Previous Page"><i class="fas fa-angle-left"></i></span>':`<a class="ais-Pagination-link" aria-label="Previous Page" href="#" data-page="${e-1}"><i class="fas fa-angle-left"></i></a>`}\n            </li>\n            ${r}\n            <li class="ais-Pagination-item ais-Pagination-item--nextPage ${n?"ais-Pagination-item--disabled":""}">\n              ${n?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Next Page"><i class="fas fa-angle-right"></i></span>':`<a class="ais-Pagination-link" aria-label="Next Page" href="#" data-page="${e+1}"><i class="fas fa-angle-right"></i></a>`}\n            </li>`:p.pagination.style.display="none"}},b=()=>{if(l.isfetched){let t=r.value.trim().toLowerCase();""!==(t=h?t.replace(/</g,"&lt;").replace(/>/g,"&gt;"):t)&&(c.hidden=!1);var e=t.split(/[-\s]+/);let a=[];0<t.length&&(a=l.getResultItems(e)),1===e.length&&""===e[0]?(document.getElementById("local-search-results").textContent="",o.textContent="",w(!1),s&&(u=[],d=0)):(0===a.length?(e=>{document.getElementById("local-search-results").textContent="";var t=document.createElement("div");t.className="search-result-stats",t.textContent=i.hits_empty.replace(/\$\{query}/,e),o.innerHTML=t.outerHTML,w(!1),s&&(u=[],d=0)})(t):(a.sort((e,t)=>e.includedCount!==t.includedCount?t.includedCount-e.includedCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id),s&&(u=a,d=0),E(t,a)),0<t.length&&(e=>{if(e&&""!==e.trim()){let t=y();(t=t.filter(t=>t.toLowerCase()!==e.toLowerCase())).unshift(e.trim()),t.length>m&&(t=t.slice(0,m)),v(t),P()}})(r.value.trim())),c.hidden=!0}},x=!1,I=document.getElementById("search-mask"),S=document.querySelector("#local-search .search-dialog"),k=()=>{window.innerWidth<768&&S.style.setProperty("--search-height",window.innerHeight+"px")},C=()=>{btf.overflowPaddingR.add(),btf.animateIn(I,"to_show 0.5s"),btf.animateIn(S,"titleScale 0.5s"),setTimeout(()=>{r.focus()},300),x||(l.isfetched||l.fetchData(),r.addEventListener("input",b),x=!0),document.addEventListener("keydown",function e(t){"Escape"===t.code&&($(),document.removeEventListener("keydown",e))}),k(),window.addEventListener("resize",k)},$=()=>{btf.overflowPaddingR.remove(),btf.animateOut(S,"search_close .5s"),btf.animateOut(I,"to_hide 0.5s"),window.removeEventListener("resize",k)},_=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",C)};window.addEventListener("search:loaded",()=>{var e=document.getElementById("loading-database");e.nextElementSibling.style.visibility="visible",e.remove()}),_(),document.querySelector("#local-search .search-close-button").addEventListener("click",$),I.addEventListener("click",$),GLOBAL_CONFIG.localSearch.preload&&l.fetchData(),l.highlightSearchWords(document.getElementById("article-container")),P(),p.historyClear&&p.historyClear.addEventListener("click",()=>{v([]),P()}),s&&p.pagination.addEventListener("click",e=>{e.preventDefault(),(e=e.target.closest("a[data-page]"))&&(e=parseInt(e.dataset.page,10),!isNaN(e))&&0<u.length&&(d=e,E(r.value.trim().toLowerCase(),u))}),w(!1),window.addEventListener("pjax:complete",()=>{btf.isHidden(I)||$(),l.highlightSearchWords(document.getElementById("article-container")),_()})});