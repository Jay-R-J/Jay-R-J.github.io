class LocalSearch{constructor({path:e="",unescape:t=!1,top_n_per_article:n=1}){this.path=e,this.unescape=t,this.top_n_per_article=n,this.isfetched=!1,this.datas=null}getIndexByWord(e,t,n=!1){const a=[],i=new Set;return n||(t=t.toLowerCase()),e.forEach(e=>{if(this.unescape){const t=document.createElement("div");t.innerText=e,e=t.innerHTML}const s=e.length;if(0===s)return;let l=0,o=-1;for(n||(e=e.toLowerCase());(o=t.indexOf(e,l))>-1;)a.push({position:o,word:e}),i.add(e),l=o+s}),a.sort((e,t)=>e.position!==t.position?e.position-t.position:t.word.length-e.word.length),[a,i]}mergeIntoSlice(e,t,n){let a=n[0],{position:i,word:s}=a;const l=[],o=new Set;for(;i+s.length<=t&&0!==n.length;){o.add(s),l.push({position:i,length:s.length});const e=i+s.length;for(n.shift();0!==n.length&&(a=n[0],i=a.position,s=a.word,e>i);)n.shift()}return{hits:l,start:e,end:t,count:o.size}}highlightKeyword(e,t){let n="",a=t.start;for(const{position:i,length:s}of t.hits)n+=e.substring(a,i),a=i+s,n+=`<mark class="search-keyword">${e.substr(i,s)}</mark>`;return n+=e.substring(a,t.end),n}getResultItems(e){const t=[];return this.datas.forEach(({title:n,content:a,url:i})=>{const[s,l]=this.getIndexByWord(e,n),[o,r]=this.getIndexByWord(e,a),c=new Set([...l,...r]).size,h=s.length+o.length;if(0===h)return;const d=[];0!==s.length&&d.push(this.mergeIntoSlice(0,n.length,s));let g=[];for(;0!==o.length;){const e=o[0],{position:t}=e,n=Math.max(0,t-20),i=Math.min(a.length,t+100);g.push(this.mergeIntoSlice(n,i,o))}g.sort((e,t)=>e.count!==t.count?t.count-e.count:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start);const u=parseInt(this.top_n_per_article,10);u>=0&&(g=g.slice(0,u));let p="";(i=new URL(i,location.origin)).searchParams.append("highlight",e.join(" ")),0!==d.length?p+=`<li class="local-search-hit-item"><a href="${i.href}"><span class="search-result-title">${this.highlightKeyword(n,d[0])}</span>`:p+=`<li class="local-search-hit-item"><a href="${i.href}"><span class="search-result-title">${n}</span>`,g.forEach(e=>{p+=`<p class="search-result">${this.highlightKeyword(a,e)}...</p>`}),p+="</a></li>",t.push({item:p,id:t.length,hitCount:h,includedCount:c})}),t}fetchData(){const e=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(t=>{this.isfetched=!0,this.datas=e?[...(new DOMParser).parseFromString(t,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(t),this.datas=this.datas.filter(e=>e.title).map(e=>(e.title=e.title.trim(),e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"",e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/"),e)),window.dispatchEvent(new Event("search:loaded"))})}highlightText(e,t,n){const a=e.nodeValue;let i=t.start;const s=[];for(const{position:e,length:l}of t.hits){const t=document.createTextNode(a.substring(i,e));i=e+l;const o=document.createElement("mark");o.className=n,o.appendChild(document.createTextNode(a.substr(e,l))),s.push(t,o)}e.nodeValue=a.substring(i,t.end),s.forEach(t=>{e.parentNode.insertBefore(t,e)})}highlightSearchWords(e){const t=new URL(location.href).searchParams.get("highlight"),n=t?t.split(" "):[];if(!n.length||!e)return;const a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null),i=[];for(;a.nextNode();)a.currentNode.parentNode.matches("button, select, textarea, .mermaid")||i.push(a.currentNode);i.forEach(e=>{const[t]=this.getIndexByWord(n,e.nodeValue);if(!t.length)return;const a=this.mergeIntoSlice(0,e.nodeValue.length,t);this.highlightText(e,a,"search-keyword")})}}window.addEventListener("load",()=>{const{path:e,top_n_per_article:t,unescape:n,languages:a,pagination:i}=GLOBAL_CONFIG.localSearch,s=i&&i.enable,l=new LocalSearch({path:e,top_n_per_article:t,unescape:n}),o=document.querySelector(".local-search-input input"),r=document.getElementById("local-search-stats"),c=document.getElementById("loading-status"),h=!e.endsWith("json");let d=0;const g=i.hitsPerPage||10;let u=[];s||(d=void 0,u=void 0);const p={get pagination(){return document.getElementById("local-search-pagination")},get paginationList(){return document.querySelector("#local-search-pagination .ais-Pagination-list")},get historyList(){return document.getElementById("local-search-history")},get historyClear(){return document.getElementById("local-search-history-clear")}},m=10,f="local_search_history",y=()=>{try{const e=localStorage.getItem(f);return e?JSON.parse(e):[]}catch(e){return[]}},P=e=>{try{localStorage.setItem(f,JSON.stringify(e))}catch(e){}},w=e=>{if(!e||""===e.trim())return;let t=y();t=t.filter(t=>t.toLowerCase()!==e.toLowerCase()),t.unshift(e.trim()),t.length>m&&(t=t.slice(0,m)),P(t),E()},v=()=>{P([]),E()},E=()=>{const e=y(),t=p.historyList;if(!t)return;if(0===e.length)return void(t.style.display="none");t.style.display="block";let n='<h4 class="search-history-title">搜索历史</h4>';n+='<ul class="search-history-list">',e.forEach((e,t)=>{n+=`\n        <li class="search-history-item">\n          <a href="#" class="search-history-link" data-term="${encodeURIComponent(e)}">\n            <i class="fas fa-history"></i>\n            <span>${e}</span>\n            <button class="search-history-remove" data-index="${t}" title="删除">\n              <i class="fas fa-times"></i>\n            </button>\n          </a>\n        </li>\n      `}),n+="</ul>",t.innerHTML=n,t.querySelectorAll(".search-history-link").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const n=decodeURIComponent(e.dataset.term);o.value=n,I(),o.focus()})}),t.querySelectorAll(".search-history-remove").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const n=parseInt(e.dataset.index);let a=y();a.splice(n,1),P(a),E()})})},L=e=>{p.pagination.style.display=s&&e?"":"none"},b=(e,t)=>{const n=document.getElementById("local-search-results"),i=s?u.slice(d*g,(d+1)*g):t;if(s&&0===i.length&&u.length>0)return d=0,void b(e,t);const l=i.map((e,t)=>{const n=s?d*g+t+1:t+1;return e.item.replace('<li class="local-search-hit-item">',`<li class="local-search-hit-item" value="${n}">`)});n.innerHTML=`<ol class="search-result-list">${l.join("")}</ol>`;const o=s?u.length:t.length,c=a.hits_stats.replace(/\$\{hits}/,o);if(r.innerHTML=`<hr><div class="search-result-stats">${c}</div>`,s){const t=Math.ceil(u.length/g);x(d,t,e)}const h=t.length>0;L(h),window.pjax&&window.pjax.refresh(n)},x=(e,t,n)=>{if(t<=1)return p.pagination.style.display="none",void(p.paginationList.innerHTML="");p.pagination.style.display="block";const a=0===e,i=e===t-1,s=window.innerWidth<768?3:5;let l=Math.max(0,e-Math.floor(s/2));const o=Math.min(t-1,l+s-1);o-l+1<s&&(l=Math.max(0,o-s+1));let r="";t>s&&l>0&&(r+='\n        <li class="ais-Pagination-item ais-Pagination-item--page">\n          <a class="ais-Pagination-link" aria-label="Page 1" href="#" data-page="0">1</a>\n        </li>',l>1&&(r+='\n          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">\n            <span class="ais-Pagination-link">...</span>\n          </li>'));for(let t=l;t<=o;t++){r+=t===e?`\n          <li class="ais-Pagination-item ais-Pagination-item--page ais-Pagination-item--selected">\n            <span class="ais-Pagination-link" aria-label="Page ${t+1}">${t+1}</span>\n          </li>`:`\n          <li class="ais-Pagination-item ais-Pagination-item--page">\n            <a class="ais-Pagination-link" aria-label="Page ${t+1}" href="#" data-page="${t}">${t+1}</a>\n          </li>`}t>s&&o<t-1&&(o<t-2&&(r+='\n          <li class="ais-Pagination-item ais-Pagination-item--ellipsis">\n            <span class="ais-Pagination-link">...</span>\n          </li>'),r+=`\n        <li class="ais-Pagination-item ais-Pagination-item--page">\n          <a class="ais-Pagination-link" aria-label="Page ${t}" href="#" data-page="${t-1}">${t}</a>\n        </li>`),t>1?p.paginationList.innerHTML=`\n            <li class="ais-Pagination-item ais-Pagination-item--previousPage ${a?"ais-Pagination-item--disabled":""}">\n              ${a?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Previous Page"><i class="fas fa-angle-left"></i></span>':`<a class="ais-Pagination-link" aria-label="Previous Page" href="#" data-page="${e-1}"><i class="fas fa-angle-left"></i></a>`}\n            </li>\n            ${r}\n            <li class="ais-Pagination-item ais-Pagination-item--nextPage ${i?"ais-Pagination-item--disabled":""}">\n              ${i?'<span class="ais-Pagination-link ais-Pagination-link--disabled" aria-label="Next Page"><i class="fas fa-angle-right"></i></span>':`<a class="ais-Pagination-link" aria-label="Next Page" href="#" data-page="${e+1}"><i class="fas fa-angle-right"></i></a>`}\n            </li>`:p.pagination.style.display="none"},I=()=>{if(!l.isfetched)return;let e=o.value.trim().toLowerCase();h&&(e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;")),""!==e&&(c.hidden=!1);const t=e.split(/[-\s]+/);let n=[];e.length>0&&(n=l.getResultItems(t)),1===t.length&&""===t[0]?(document.getElementById("local-search-results").textContent="",r.textContent="",L(!1),s&&(u=[],d=0)):0===n.length?((e=>{document.getElementById("local-search-results").textContent="";const t=document.createElement("div");t.className="search-result-stats",t.textContent=a.hits_empty.replace(/\$\{query}/,e),r.innerHTML=t.outerHTML,L(!1),s&&(u=[],d=0)})(e),e.length>0&&w(o.value.trim())):(n.sort((e,t)=>e.includedCount!==t.includedCount?t.includedCount-e.includedCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id),s&&(u=n,d=0),b(e,n),e.length>0&&w(o.value.trim())),c.hidden=!0};let S=!1;const k=document.getElementById("search-mask"),C=document.querySelector("#local-search .search-dialog"),$=()=>{window.innerWidth<768&&C.style.setProperty("--search-height",window.innerHeight+"px")},_=()=>{btf.overflowPaddingR.add(),btf.animateIn(k,"to_show 0.5s"),btf.animateIn(C,"titleScale 0.5s"),setTimeout(()=>{o.focus()},300),S||(!l.isfetched&&l.fetchData(),o.addEventListener("input",I),S=!0),document.addEventListener("keydown",function e(t){"Escape"===t.code&&(B(),document.removeEventListener("keydown",e))}),$(),window.addEventListener("resize",$)},B=()=>{btf.overflowPaddingR.remove(),btf.animateOut(C,"search_close .5s"),btf.animateOut(k,"to_hide 0.5s"),window.removeEventListener("resize",$)},N=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",_)};window.addEventListener("search:loaded",()=>{const e=document.getElementById("loading-database");e.nextElementSibling.style.visibility="visible",e.remove()}),N(),document.querySelector("#local-search .search-close-button").addEventListener("click",B),k.addEventListener("click",B),GLOBAL_CONFIG.localSearch.preload&&l.fetchData(),l.highlightSearchWords(document.getElementById("article-container")),E(),p.historyClear&&p.historyClear.addEventListener("click",v),s&&p.pagination.addEventListener("click",e=>{e.preventDefault();const t=e.target.closest("a[data-page]");if(t){const e=parseInt(t.dataset.page,10);!isNaN(e)&&u.length>0&&(d=e,b(o.value.trim().toLowerCase(),u))}}),L(!1),window.addEventListener("pjax:complete",()=>{!btf.isHidden(k)&&B(),l.highlightSearchWords(document.getElementById("article-container")),N()})});